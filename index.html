
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KP 車隊 ID 申報處</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>
</head>
<body class="bg-gray-100 antialiased">
    <div id="root"></div>
    <script type="module">
        // External Imports
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy, Timestamp } from 'firebase/firestore';

        // types.ts content (as JS structures)
        // Represents an entry in the database
        // type Entry = {
        //   id: string;
        //   lineName: string;
        //   gameId: string;
        //   createdAt: Timestamp;
        //   updatedAt?: Timestamp;
        // };

        // Represents data submitted from the form
        // type EntryFormData = {
        //   lineName: string;
        //   gameId: string;
        // };

        // firebaseConfig.ts content
        const firebaseConfig = {
          apiKey: "AIzaSyCm2kW4K9Hl1VzaiW3ZYwNdLlSZxdduUro",
          authDomain: "id-search-f9ddc.firebaseapp.com",
          projectId: "id-search-f9ddc",
          storageBucket: "id-search-f9ddc.firebasestorage.app",
          messagingSenderId: "543117017622",
          appId: "1:543117017622:web:98650a0fe943ab00ebeb37",
          measurementId: "G-GK0SB6LSXG"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // services/firebaseService.ts content
        const COLLECTION_NAME = 'kpRacingTeamEntries';

        const subscribeToEntries = (callback) => {
          const q = query(collection(db, COLLECTION_NAME), orderBy('createdAt', 'asc'));
          
          const unsubscribe = onSnapshot(q, (snapshot) => {
            const entries = snapshot.docs.map(d => {
                const data = d.data();
                return {
                    id: d.id,
                    lineName: data.lineName,
                    gameId: data.gameId,
                    createdAt: data.createdAt, // Firebase returns Timestamp directly
                    updatedAt: data.updatedAt, // Firebase returns Timestamp directly, might be undefined
                };
            });
            callback(entries);
          }, (error) => {
            console.error("Error subscribing to entries:", error);
          });
          return unsubscribe;
        };

        const addEntry = async (entry) => {
          try {
            const docRef = await addDoc(collection(db, COLLECTION_NAME), {
              ...entry,
              createdAt: Timestamp.now(),
            });
            console.log("Document written with ID: ", docRef.id);
            return docRef.id;
          } catch (e) {
            console.error("Error adding document: ", e);
            throw e;
          }
        };

        const updateEntry = async (entry) => {
          try {
            const entryRef = doc(db, COLLECTION_NAME, entry.id);
            await updateDoc(entryRef, {
              lineName: entry.lineName,
              gameId: entry.gameId,
              updatedAt: Timestamp.now(), // Update modification timestamp
            });
            console.log("Document updated with ID: ", entry.id);
          } catch (e) {
            console.error("Error updating document: ", e);
            throw e;
          }
        };

        const deleteEntry = async (id) => {
          try {
            await deleteDoc(doc(db, COLLECTION_NAME, id));
            console.log("Document deleted with ID: ", id);
          } catch (e) {
            console.error("Error deleting document: ", e);
            throw e;
          }
        };

        // components/EntryForm.tsx content (JSX converted to React.createElement)
        const EntryForm = ({ onSave, editingEntry, onCancelEdit }) => {
          const [lineName, setLineName] = useState('');
          const [gameId, setGameId] = useState('');
          const [isFormValid, setIsFormValid] = useState(false);

          useEffect(() => {
            if (editingEntry) {
              setLineName(editingEntry.lineName);
              setGameId(editingEntry.gameId);
            } else {
              setLineName('');
              setGameId('');
            }
          }, [editingEntry]);

          useEffect(() => {
            setIsFormValid(lineName.trim() !== '' && gameId.trim() !== '');
          }, [lineName, gameId]);

          const handleSubmit = useCallback((event) => {
            event.preventDefault();
            if (!isFormValid) {
              return;
            }

            const formData = {
              lineName: lineName.trim(),
              gameId: gameId.trim(),
            };
            onSave(formData, editingEntry?.id);
            setLineName('');
            setGameId('');
          }, [lineName, gameId, editingEntry, onSave, isFormValid]);

          const handleCancel = useCallback(() => {
            onCancelEdit();
            setLineName('');
            setGameId('');
          }, [onCancelEdit]);

          return (
            React.createElement('form', { onSubmit: handleSubmit, className: "bg-white shadow-md rounded-lg p-6 mb-8" },
              React.createElement('h2', { className: "text-xl font-semibold mb-4 text-indigo-800" },
                editingEntry ? '編輯車隊成員資料' : '新增車隊成員資料'
              ),
              React.createElement('div', { className: "mb-4" },
                React.createElement('label', { htmlFor: "lineName", className: "block text-gray-700 text-sm font-bold mb-2" },
                  "Line 名字:"
                ),
                React.createElement('input', {
                  type: "text",
                  id: "lineName",
                  value: lineName,
                  onChange: (e) => setLineName(e.target.value),
                  placeholder: "輸入 Line 名字",
                  className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",
                  required: true
                })
              ),
              React.createElement('div', { className: "mb-6" },
                React.createElement('label', { htmlFor: "gameId", className: "block text-gray-700 text-sm font-bold mb-2" },
                  "遊戲 ID:"
                ),
                React.createElement('input', {
                  type: "text",
                  id: "gameId",
                  value: gameId,
                  onChange: (e) => setGameId(e.target.value),
                  placeholder: "輸入遊戲 ID",
                  className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",
                  required: true
                })
              ),
              React.createElement('div', { className: "flex justify-end space-x-4" },
                editingEntry && (
                  React.createElement('button', {
                    type: "button",
                    onClick: handleCancel,
                    className: "px-4 py-2 rounded-md font-semibold text-white bg-gray-400 hover:bg-gray-500 transition duration-200"
                  },
                    "取消編輯"
                  )
                ),
                React.createElement('button', {
                  type: "submit",
                  disabled: !isFormValid,
                  className: `px-4 py-2 rounded-md font-semibold text-white transition duration-200 ${
                    isFormValid ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-indigo-300 cursor-not-allowed'
                  }`
                },
                  editingEntry ? '更新資料' : '申報 ID'
                )
              )
            )
          );
        };

        // components/EntryListItem.tsx content (JSX converted to React.createElement)
        const formatTimestamp = (timestamp) => {
          if (!timestamp) {
            return 'N/A';
          }
          const date = timestamp.toDate();
          return date.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
        };

        const EntryListItem = ({ entry, onEdit, onDelete }) => {
          const displayTime = entry.updatedAt || entry.createdAt;

          return (
            React.createElement('tr', { className: "bg-white border-b border-gray-200 hover:bg-gray-50" },
              React.createElement('td', { className: "py-3 px-4 text-gray-800" }, entry.lineName),
              React.createElement('td', { className: "py-3 px-4 text-gray-800" }, entry.gameId),
              React.createElement('td', { className: "py-3 px-4 text-gray-800 text-sm" }, formatTimestamp(displayTime)),
              React.createElement('td', { className: "py-3 px-4 text-right" },
                React.createElement('button', {
                  onClick: () => onEdit(entry.id),
                  className: "mr-2 px-3 py-1 text-sm rounded-md font-medium text-white bg-blue-500 hover:bg-blue-600 transition duration-200"
                },
                  "編輯"
                ),
                React.createElement('button', {
                  onClick: () => onDelete(entry.id),
                  className: "px-3 py-1 text-sm rounded-md font-medium text-white bg-red-500 hover:bg-red-600 transition duration-200"
                },
                  "刪除"
                )
              )
            )
          );
        };

        // components/EntryList.tsx content (JSX converted to React.createElement)
        const EntryList = ({ entries, onEdit, onDelete }) => {
          if (entries.length === 0) {
            return (
              React.createElement('div', { className: "bg-white shadow-md rounded-lg p-6 text-center text-gray-500" },
                "目前沒有申報資料。請新增第一個成員！"
              )
            );
          }

          return (
            React.createElement('div', { className: "bg-white shadow-md rounded-lg overflow-hidden" },
              React.createElement('h2', { className: "text-xl font-semibold p-6 text-indigo-800 border-b border-gray-200" },
                "KP 車隊成員列表"
              ),
              React.createElement('table', { className: "w-full text-left table-auto border-collapse" },
                React.createElement('thead', { className: "bg-indigo-100 text-indigo-800 uppercase text-sm font-semibold" },
                  React.createElement('tr', null,
                    React.createElement('th', { className: "py-3 px-4" }, "Line 名字"),
                    React.createElement('th', { className: "py-3 px-4" }, "遊戲 ID"),
                    React.createElement('th', { className: "py-3 px-4" }, "加入/修改 時間"),
                    React.createElement('th', { className: "py-3 px-4 text-right" }, "操作")
                  )
                ),
                React.createElement('tbody', null,
                  entries.map((entry) => (
                    React.createElement(EntryListItem, { key: entry.id, entry: entry, onEdit: onEdit, onDelete: onDelete })
                  ))
                )
              )
            )
          );
        };

        // App.tsx content (JSX converted to React.createElement)
        function App() {
          const [entries, setEntries] = useState([]);
          const [editingEntry, setEditingEntry] = useState(null);
          const [loading, setLoading] = useState(true);
          const [searchTerm, setSearchTerm] = useState('');

          useEffect(() => {
            const unsubscribe = subscribeToEntries((fetchedEntries) => {
              setEntries(fetchedEntries);
              setLoading(false);
            });
            return () => unsubscribe();
          }, []);

          const handleSaveEntry = useCallback(async (formData, id) => {
            try {
              if (id) {
                const existingEntry = entries.find(entry => entry.id === id);
                if (existingEntry) {
                  await updateEntry({
                    ...existingEntry,
                    lineName: formData.lineName,
                    gameId: formData.gameId,
                  });
                  setEditingEntry(null);
                } else {
                  console.error(`Attempted to update entry with ID ${id} but it was not found.`);
                }
              } else {
                await addEntry(formData);
              }
            } catch (error) {
              console.error("Failed to save entry:", error);
            }
          }, [entries, editingEntry]);

          const handleEditEntry = useCallback((id) => {
            const entryToEdit = entries.find(entry => entry.id === id);
            if (entryToEdit) {
              setEditingEntry(entryToEdit);
            }
          }, [entries]);

          const handleDeleteEntry = useCallback(async (id) => {
            if (window.confirm('確定要刪除這筆資料嗎？')) {
              try {
                await deleteEntry(id);
                if (editingEntry?.id === id) {
                  setEditingEntry(null);
                }
              } catch (error) {
                console.error("Failed to delete entry:", error);
              }
            }
          }, [editingEntry]);

          const handleCancelEdit = useCallback(() => {
            setEditingEntry(null);
          }, []);

          const filteredEntries = useMemo(() => {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            return entries.filter(entry =>
              entry.lineName.toLowerCase().includes(lowerCaseSearchTerm) ||
              entry.gameId.toLowerCase().includes(lowerCaseSearchTerm)
            );
          }, [entries, searchTerm]);

          return (
            React.createElement('div', { className: "min-h-screen bg-gray-100 p-4 md:p-8" },
              React.createElement('div', { className: "max-w-4xl mx-auto" },
                React.createElement('h1', { className: "text-3xl md:text-4xl font-extrabold text-center mb-8 text-indigo-700" },
                  "KP 車隊 ID 申報處"
                ),
                React.createElement(EntryForm, { onSave: handleSaveEntry, editingEntry: editingEntry, onCancelEdit: handleCancelEdit }),
                React.createElement('div', { className: "mb-6" },
                  React.createElement('input', {
                    type: "text",
                    placeholder: "搜尋 Line 名字或遊戲 ID...",
                    className: "w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",
                    value: searchTerm,
                    onChange: (e) => setSearchTerm(e.target.value),
                    'aria-label': "搜尋 Line 名字或遊戲 ID"
                  })
                ),
                loading ? (
                  React.createElement('div', { className: "text-center text-gray-600 text-lg font-medium mt-8" }, "載入中...")
                ) : (
                  React.createElement(EntryList, { entries: filteredEntries, onEdit: handleEditEntry, onDelete: handleDeleteEntry })
                )
              )
            )
          );
        }

        // index.tsx content (main render logic)
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          React.createElement(React.StrictMode, null,
            React.createElement(App, null)
          )
        );
    </script>
</body>
</html>